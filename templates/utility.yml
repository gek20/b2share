default:
  before_script:
    - apk add --no-cache -q openssh bash git curl jq wget
    - curl -sfL https://install-cli.jfrog.io | sh

  after_script:
    - '[[ "${CI_JOB_STAGE}" == "test" ]] && exit 0'
    - docker image ls
    - IMGS_TO_REMOVE=$(docker image ls --filter dangling=true -q)
    - set -exu
    - '[[ -z ${IMGS_TO_REMOVE} ]] || docker image rm -f ${IMGS_TO_REMOVE}'


.config:
  common:
    - mkdir -p ~/.docker ~/.pip
    - printf "${DOCKER_CONF}" > ~/.docker/config.json
    - printf "${PIP_CONF}" > ~/.pip/pip.conf
    - printf "${NPMRC}" > ~/.npmrc
    - |
      printf "Error checking...\n"
      [[ "$(cat ~/.docker/config.json)" = *"nil"* ]] && (printf "\n<nil> value detected in ~/.docker/config.json\n" && exit 10)
      [[ "$(cat ~/.pip/pip.conf)" = *"nil"* ]] && (printf "\n<nil> value detected in ~/.pip/pip.conf\n" && exit 11)
      [[ "$(cat ~/.npmrc)" = *"nil"* ]] && (printf "\n<nil> value detected in ~/.npmrc\n" && exit 12)


.jfrog:
  connect:
    - jf config add af-server --artifactory-url=${ARTIFACTORY_URL} --user=${ARTIFACTORY_USER} --password=${ARTIFACTORY_PASS}
    - jf config show
  push:
    - jf rt dp ${IMAGE} eudat-docker --build-name=${JF_BUILD_NAME} --build-number=${JF_BUILD_NUMBER}
    - jf rt dp ${IMAGE_BASE} eudat-docker --build-name=${JF_BUILD_NAME} --build-number=${JF_BUILD_NUMBER}
    - jf rt bp ${JF_BUILD_NAME} ${JF_BUILD_NUMBER}